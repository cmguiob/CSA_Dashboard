---
title: "Dashbaord Q1 - Locations"
subtitle: "Labelled and interactive maps"
author: "Carlos Gu√≠o"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: journal
    highlight: tango
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(include = FALSE, echo = FALSE, warning = FALSE, message = FALSE, fig.align="center", fig.showtext = TRUE, fig.retina = 1, dpi = 300, out.width = "75%")


```

```{r read}
library(tidyverse)

#Read
Q1_practices <- read_csv(here::here("Data","EU-IFAD","Q1_practices.csv")) %>%
      select(location_type,
             location_name, 
             hh_address,
             hh_head_gender,
             head,
             farmer_id,
             farmer_gender,
             year, 
             exposure_weather, 
             weather_shocks,
             outcome_category,
             practice_type,
             adopted_cases, 
             mitigation,
             gender_impact) %>%
      pivot_wider(names_from = location_type, values_from = location_name) %>%
      unchop(everything()) %>%
      mutate(practice_type = str_to_sentence(practice_type),
             farmer_id = case_when(
               farmer_id == "337a45e573817fba21d251ecc3a37523e14cc62d073" & 
               farmer_gender == "Female" ~ "337a45e573817fba21d251ecc3a37523e14cc62d073_F",
               farmer_id == "3e2a4c557a0a5277638e42df23b17bd63eb41858faa" & 
               farmer_gender == "Female" ~ "3e2a4c557a0a5277638e42df23b17bd63eb41858faa_F",
               farmer_id == "4e6a1f557611aec6b347a05cde3a1e093fb88e883a0" & 
               farmer_gender == "Female" ~ "4e6a1f557611aec6b347a05cde3a1e093fb88e883a0_F",
               farmer_id == "533a330570d0a9e20fdd55e40993645a7c9838e11b0" & 
               farmer_gender == "Female" ~ "533a330570d0a9e20fdd55e40993645a7c9838e11b0_F",
               farmer_id == "27fa75957420473f9ad14deb5ed9b7701031f701149" & 
               farmer_gender == "Female" ~ "27fa75957420473f9ad14deb5ed9b7701031f701149_F",
               farmer_id == "a75acb457efe9fb18b082f3a52d2dad46a69a42cf8e" & 
               farmer_gender == "Female" ~ "a75acb457efe9fb18b082f3a52d2dad46a69a42cf8e_F",
               farmer_id == "112a7c157220d8de79f29b9ac7bf6af20daa0a05983" & 
               farmer_gender == "Female" ~ "112a7c157220d8de79f29b9ac7bf6af20daa0a05983_F",
               farmer_id == "fd7a65f575e4ac103cbe3b6832d559cbc199d82101b" & 
               farmer_gender == "Female" ~ "fd7a65f575e4ac103cbe3b6832d559cbc199d82101b_F",
               TRUE ~ farmer_id),
             gender_impact = case_when(practice_type == "Irrigation and groundwater pumping" ~
                                         "no",
                                       practice_type == "Water harvesting" ~ "no",
                                       practice_type == "Pasture management" ~ "no",
                                       TRUE ~ gender_impact)) 
  

# Previous cleaning tricks
  #Replace anything after open parentheses
  #mutate(practice = str_replace(practice, "(?<=\\().+", "")) %>%
  #Replace parentheses
  #mutate(practice = str_replace(practice, "\\(", "")) %>%
  # Replace anything after colon
  #mutate(practice = str_replace(practice, "(?<=\\:).+", "")) %>%
  #Replace colon
  #mutate(practice = str_replace(practice, "\\:", "")) %>%
  # Replace anything after quotes
  #mutate(practice = str_replace(practice, "(?<=[\"]).+", "")) %>%
  # Replace quotes
  #mutate(practice = str_replace(practice, "[\"]", "")) %>%
  # Format to sentence with first letter uppercase
  #mutate(practice = str_to_sentence(practice))%>%
  # Remove period at the end
  #mutate(practice = str_replace(practice, "[\\.]", "")) %>%
  # Remove text after dash and space
  #mutate(practice = str_replace(practice, "(?<=[\\-])\\s.+", "")) %>%
  #Remove dash at the end of sentence
  #mutate(practice = str_replace(practice, "[\\-]$", "")) %>%
  #mutate(practice = str_trim(practice))

Q1_services <- read_csv(here::here("Data","EU-IFAD","Q1_services.csv")) %>%
              select(location_type, 
                       location_name, 
                       hh_address,
                       hh_head_gender,
                       head,
                       farmer_id, 
                       farmer_gender,
                       year, 
                       exposure_weather,
                       weather_shocks,
                       practice_type, 
                       adopted_cases) %>%
                pivot_wider(names_from = location_type, values_from = location_name) %>%
                unchop(everything()) %>%
                mutate(option = "Services",
                       mitigation = "Does not apply",
                       gender_impact = "Does not apply",
                       outcome_category = "Does not apply",
                       farmer_id = case_when(
               farmer_id == "337a45e573817fba21d251ecc3a37523e14cc62d073" & 
               farmer_gender == "Female" ~ "337a45e573817fba21d251ecc3a37523e14cc62d073_F",
               farmer_id == "3e2a4c557a0a5277638e42df23b17bd63eb41858faa" & 
               farmer_gender == "Female" ~ "3e2a4c557a0a5277638e42df23b17bd63eb41858faa_F",
               farmer_id == "4e6a1f557611aec6b347a05cde3a1e093fb88e883a0" & 
               farmer_gender == "Female" ~ "4e6a1f557611aec6b347a05cde3a1e093fb88e883a0_F",
               farmer_id == "533a330570d0a9e20fdd55e40993645a7c9838e11b0" & 
               farmer_gender == "Female" ~ "533a330570d0a9e20fdd55e40993645a7c9838e11b0_F",
               farmer_id == "27fa75957420473f9ad14deb5ed9b7701031f701149" & 
               farmer_gender == "Female" ~ "27fa75957420473f9ad14deb5ed9b7701031f701149_F",
               farmer_id == "a75acb457efe9fb18b082f3a52d2dad46a69a42cf8e" & 
               farmer_gender == "Female" ~ "a75acb457efe9fb18b082f3a52d2dad46a69a42cf8e_F",
               farmer_id == "112a7c157220d8de79f29b9ac7bf6af20daa0a05983" & 
               farmer_gender == "Female" ~ "112a7c157220d8de79f29b9ac7bf6af20daa0a05983_F",
               farmer_id == "fd7a65f575e4ac103cbe3b6832d559cbc199d82101b" & 
               farmer_gender == "Female" ~ "fd7a65f575e4ac103cbe3b6832d559cbc199d82101b_F",
               TRUE ~ farmer_id)) 

Q1_options <- bind_rows(Q1_practices, Q1_services)

Q1_options

```


Summary for years should list the years surveyed.
```{r}
#Summaries for years
summ_yea <- Q1_options %>% 
            group_by(region, country, site) %>% 
            distinct(year) %>% 
            count() %>% 
            mutate(category = "Years")  %>% 
            ungroup()

details_years <- aggregate(year ~ site, unique(Q1_options %>% 
                                               group_by(region, country, site) %>% 
                                               distinct(year)), paste, collapse = "\n ") 

```

Summary of the number of communities per site.

```{r}

#Summaries for communities
summ_com <- Q1_options %>% 
            group_by(region, country, site) %>% 
            distinct(community) %>% 
            count() %>% 
            mutate(category = "Communities")  %>% 
            ungroup()

```

Summary of practices evaluated at each site

```{r}

#Summaries for practices evaluated
summ_prac <- Q1_practices %>% 
             group_by(region, country, site) %>% 
             distinct(practice_type) %>% 
             count() %>% 
             mutate(category = "Practices")  %>% 
             ungroup()

details_practices <- aggregate(practice_type ~ site, 
                               unique(Q1_practices %>%
                                      group_by(region, country, site) %>%
                                      distinct(practice_type, .keep_all = TRUE) %>%
                                      mutate(practice_type = case_when(
                                        mitigation == "yes" & gender_impact == "yes"~ 
                                          paste(practice_type,"(m & g)"),
                                        mitigation == "yes" & gender_impact == "no"~ 
                                          paste(practice_type,"(m)"),
                                        mitigation == "no" & gender_impact == "yes"~
                                          paste(practice_type,"(g)"),
                                        mitigation == "no" & gender_impact == "no"~
                                          practice_type))), 
                               paste, collapse = "\n ") %>%
                      mutate(practice_type = paste(practice_type, 
                                                   "(m: mitigation, g: gender impact)",
                                                   sep = "\n"))

```

Summaries for CIS provided at each site

```{r}

#Summaries for CIS provided
summ_serv <- Q1_services %>% 
             filter(practice_type != "No service") %>% 
             group_by(region, country, site) %>% 
             distinct(practice_type) %>% 
             count() %>% 
             mutate(category = "Services")  %>% 
             ungroup()

details_services <- aggregate(practice_type ~ site, 
                              unique(Q1_services %>% 
                                     filter(practice_type != "No service") %>% 
                                     group_by(region, country, site) %>%
                                     distinct(practice_type)), paste, collapse = "\n ") 

```


Summary of  households

```{r}

#Summary of number of households
summ_hh <- Q1_options %>% 
           group_by(region, country, site) %>% 
           distinct(hh_address, .keep_all = TRUE) %>% 
           count() %>% 
           mutate(category = "Households") %>% 
           ungroup()

#Summary of number of households. 

# IMPORTANT: If grouped by hh_head_gender before distinct, more rows are obtained, because some households answered twice, both as male and female headed (each giving different answers to weather shocks, driver, adoption_case, e.g. KAF-03-013). On the contrary, if distinct is used first, some households are deleted, leaving just the hh_head_gender whose row appears first (e.g. doy-03-019, KAF-03-001).

summ_hh_g <- Q1_options %>% 
             group_by(region, country, site, hh_head_gender)  %>% 
             distinct(hh_address, .keep_all = TRUE) %>% 
             count() %>% 
             mutate(category = "Households",
                    hh_head_gender = case_when(
                      hh_head_gender == "Female-headed" ~ "female-headed",
                      hh_head_gender == "Male-headed" ~ "male-headed",
                      TRUE ~ "gender not reported"
                    )) %>% 
             ungroup()

summ_hh_g

```


Summary of global practice-adoptant households

```{r}
# Summary of number of adoptant households
#IMPORTANT: filter must be applied at the beginning. If applied after grouping, the number of rows is reduced wrongly.
summ_adhh <- Q1_practices %>% 
             filter(adopted_cases == "Implemented")  %>% 
             group_by(region, country, site)  %>%  
             distinct(hh_address, .keep_all = TRUE) %>% 
             count() %>% 
             mutate(category = "Households implementing")  %>% 
             ungroup()

# Detail of % of adoptant households
details_adoptant_hh <- summ_hh %>% 
                       ungroup() %>%
                       select(site, n) %>% 
                       inner_join(summ_adhh %>% 
                                    ungroup()%>% 
                                    select(site,n), 
                                    by = "site") %>%
                       mutate(adoptant_hh_perc = paste0(round(n.y*100/n.x, 0), 
                                         "% implemented at least 1 practice."))%>%
                      select(-n.x, -n.y) 

details_adoptant_hh

```


Summary of practice-adoptant households dis-aggregated by gender

```{r}

# Summary of number of adoptant households
summ_adhh_g <- Q1_practices %>% 
               filter(adopted_cases == "Implemented")  %>% 
               group_by(region, country, site, hh_head_gender)  %>%  
               distinct(hh_address, .keep_all = TRUE) %>% 
               count() %>% 
               mutate(category = "Households implementing",
                      hh_head_gender = case_when(
                        hh_head_gender == "Female-headed" ~ "female-headed",
                        hh_head_gender == "Male-headed" ~ "male-headed",
                        TRUE ~ "gender unreported"
                    ))  %>% 
               ungroup()

# Detail of % of adoptant households disaggregated
details_adoptant_hh_g <- summ_adhh %>% 
                         ungroup() %>%
                         select(site, n) %>% 
                         inner_join(summ_adhh_g %>% 
                                      ungroup()%>%
                                      select(site, hh_head_gender, n), 
                                    by =  "site") %>%
                         filter(hh_head_gender == "female-headed" | 
                                  hh_head_gender == "male-headed") %>%
                         mutate(adoptant_hh_g_perc = paste0(round(n.y*100/n.x, 0), 
                                                            "%  were ",
                                                            paste(hh_head_gender)))%>%
                         select(-n.x, -n.y, -hh_head_gender) %>%
                         aggregate(adoptant_hh_g_perc ~ site,
                                   data = ., 
                                   paste,
                                   collapse = "\n ") %>%
                         inner_join(details_adoptant_hh) %>%
                         mutate(adoptant_hh_g_perc = paste(adoptant_hh_perc, 
                                                           "From them:", 
                                                           adoptant_hh_g_perc, 
                                                           sep= "\n")) %>%
                         select(-adoptant_hh_perc)

details_adoptant_hh_g
```

Summary of global CIS-access households

```{r}

# Summary of number of CIS access households
summ_acchh <- Q1_services %>% 
              filter(adopted_cases != "No accessed") %>%
              filter(!is.na(adopted_cases))  %>%
              group_by(region, country, site)  %>%  
              distinct(hh_address, .keep_all = TRUE) %>% 
              count() %>% 
              mutate(category = "Households accessing CIS")  %>% 
              ungroup()

# Detail of % of CIS access households
details_access_hh <- summ_hh %>% 
                     ungroup() %>%
                     select(site, n) %>% 
                     inner_join(summ_acchh %>% 
                                ungroup() %>%
                                select(site,n), by = "site") %>%
                     mutate(access_hh_perc = paste0(round(n.y*100/n.x, 0), 
                                                    "% accessed CIS"))%>%
                     select(-n.x, -n.y) 

details_access_hh
```


Summary of CIS-access households dis-aggregated by gender

```{r}

# Summary of number of adoptant households
summ_acchh_g <- Q1_services %>% 
                filter(adopted_cases != "No accessed") %>%
                filter(!is.na(adopted_cases)) %>% 
                distinct(hh_address, .keep_all = TRUE) %>%  
                group_by(region, country, site, hh_head_gender)  %>%  
                count() %>% 
                mutate(category = "Households accessing CIS",
                      hh_head_gender = case_when(
                        hh_head_gender == "Female-headed" ~ "female-headed",
                        hh_head_gender == "Male-headed" ~ "male-headed",
                        TRUE ~ "gender unreported"
                    ))  %>% 
                ungroup()

# Detail of % of adoptant households disaggregated
details_access_hh_g <- summ_acchh %>% 
    ungroup() %>%
    select(site, n) %>% 
    inner_join(summ_acchh_g %>% 
               ungroup()%>%
               select(site, hh_head_gender, n), 
               by =  "site") %>%
    filter(hh_head_gender == "female-headed" | hh_head_gender == "male-headed") %>%
    mutate(access_hh_g_perc = paste0(round(n.y*100/n.x, 0), 
                                     "%  were ", 
                                     paste(hh_head_gender)))%>%
    select(-n.x, -n.y, -hh_head_gender) %>%
    aggregate(access_hh_g_perc ~ site,
                            data = ., 
                            paste, 
                            collapse = "\n ") %>%
  inner_join(details_access_hh) %>%
  mutate(access_hh_g_perc = paste(access_hh_perc, 
                                  "From them:", 
                                  access_hh_g_perc, 
                                  sep= "\n")) %>%
  select(-access_hh_perc)

details_access_hh_g

```

Summaries for weather shocks

```{r}
#Number of households that experienced a weather shock
summ_weaxp <- Q1_practices %>% 
              filter(exposure_weather == "yes") %>%
              group_by(region, country, site) %>%  
              distinct(hh_address) %>% 
              count() %>% 
              mutate(category = "Weather schocks")  %>% 
              ungroup()

# Percentage of households that experienced a weather shock
summ_weaxp_per <- summ_hh %>% 
                  select(-category) %>% 
                  inner_join(summ_weaxp %>% 
                             select(-category), 
                             by = c("region", "country", "site")) %>%
                  mutate(n = round(n.y*100/n.x, 0),
                         category = "Weather shocks")%>%
                  select(-n.x, -n.y)


```


Summaries of households that made changes due to weather

```{r}

#Number of households that made changes due to weather shocks.
summ_weach <- Q1_practices %>% 
              filter(outcome_category == "Changes due to weather events" &
                     exposure_weather == "yes") %>%
              group_by(region, country, site) %>%  
              distinct(hh_address) %>% 
              count() %>% 
              mutate(category = "Changes due to weather")  %>% 
              ungroup()

summ_weaau <- Q1_practices %>% 
              filter(outcome_category == "Autonomous changes" &
                     exposure_weather == "yes") %>%
              group_by(region, country, site) %>%  
              distinct(hh_address) %>% 
              count() %>% 
              mutate(category = "Autonomous changes")  %>% 
              ungroup()


# Percentage of households that experienced a weather shock
summ_weach_per <- summ_weaxp %>% 
                  select(-category) %>% 
                  inner_join(summ_weach %>% 
                             select(-category), 
                             by = c("region", "country", "site")) %>%
                  mutate(perc = round(n.y*100/n.x, 0),
                         category = paste(paste0(perc, "%"),
                                          "made changes due to weather"))%>%
                  select(-n.y, -perc) %>%
                  inner_join(summ_weaau %>% 
                             select(-category), 
                             by = c("region", "country", "site")) %>%
                  mutate(perc = round(n*100/n.x, 0),
                         category = paste(category,
                                          "\n and", 
                                          paste0(perc, "%"),
                                          "made also autonomous changes."))%>%
                  select(-n.x, -n, -perc)

summ_weach_per


#Details weather: list of top3 and % changes due to weather
details_weashk <- Q1_practices %>% 
                  filter(exposure_weather == "yes",
                         weather_shocks != "Not reported") %>%
                  group_by(site, weather_shocks) %>% 
                  
                  distinct(hh_address) %>% 
                  count() %>% 
                  ungroup() %>%
                  group_by(site, n) %>%
                  arrange(weather_shocks, .by_group = TRUE) %>%
                  ungroup() %>%
                  group_by(site) %>%
                  top_n(3) %>%
                  select(-n) %>%
                  aggregate(weather_shocks ~ site,
                            data = ., 
                            paste, 
                            collapse = "\n ") %>%
                  left_join(summ_weach_per %>%
                              select(site, category),
                            by = c("site")) %>%
                  mutate(weather_details = paste(category,"The most common shocks were:" ,weather_shocks, sep = "\n")) %>%
                  select(-category, -weather_shocks)

details_weashk



```


Summaries of farmers

```{r summary_farmers}

# Number of farmers per site
summ_frm <- Q1_options %>% 
            group_by(region, country, site) %>% 
            distinct(farmer_id, .keep_all = TRUE) %>% 
            count() %>% 
            mutate(category = "Farmers")  %>% 
            ungroup()

#Summary of farmers by gender
summ_frm_g <- Q1_options %>% 
             group_by(region, country, site, farmer_gender)  %>% 
             distinct(farmer_id, .keep_all = TRUE) %>% 
             count() %>% 
             mutate(category = "Farmers",
                    farmer_gender = case_when(
                      farmer_gender == "Female" ~ "Female",
                      farmer_gender == "Male" ~ "Male",
                      TRUE ~ "gender  not reported"
                    )) %>% 
             ungroup()

```

Summaries of practice-adoptant farmers

```{r}
# Number of adoptant farmers per site
summ_adfrm <- Q1_practices %>% 
              filter(adopted_cases == "Implemented") %>%
              group_by(region, country, site)  %>% 
              distinct(farmer_id) %>% 
              count() %>% 
              mutate(category = "Farmers implementing") %>% ungroup()

# Percentage of farmers that adopted, narrated
details_adoptant_frm <- summ_frm %>% 
                        ungroup() %>%
                        select(site,n) %>% 
                        inner_join(summ_adfrm %>% 
                                     ungroup()%>%
                                     select(site,n), 
                                   by = "site") %>%
                        mutate(adoptant_frm_perc = paste0(round(n.y*100/n.x, 0), 
                                      "% implemented\n at least one practice."))%>%
                        select(-n.x, -n.y) 
```


Summary of practice-adoptant farmers dis-aggregated by gender

```{r}

# Summary of number of adoptant households
summ_frm_g <- Q1_practices %>% 
               filter(adopted_cases == "Implemented")  %>% 
               group_by(region, country, site, farmer_gender)  %>%  
               distinct(farmer_id, .keep_all = TRUE) %>% 
               count() %>% 
               mutate(category = "Farmers implementing",
                      farmer_gender = case_when(
                      farmer_gender == "Female" ~ "female",
                      farmer_gender == "Male" ~ "male",
                      TRUE ~ "gender unreported"
                    ))  %>% 
               ungroup()

# Detail of % of adoptant households disaggregated
details_adoptant_frm_g <- summ_frm %>% 
                         ungroup() %>%
                         select(site, n) %>% 
                         inner_join(summ_frm_g %>% 
                                      ungroup()%>%
                                      select(site, farmer_gender, n), 
                                    by =  "site") %>%
                         filter(farmer_gender == "female" | 
                                  farmer_gender == "male") %>%
                         mutate(adoptant_frm_g_perc = paste0(round(n.y*100/n.x, 0), 
                                                            "%  were ",
                                                            paste(farmer_gender)))%>%
                         select(-n.x, -n.y, -farmer_gender) %>%
                         aggregate(adoptant_frm_g_perc ~ site,
                                   data = ., 
                                   paste,
                                   collapse = "\n ") %>%
                         inner_join(details_adoptant_frm) %>%
                         mutate(adoptant_frm_g_perc = paste(adoptant_frm_perc, 
                                                           "From them:", 
                                                           adoptant_frm_g_perc, 
                                                           sep= "\n")) %>%
                         select(-adoptant_frm_perc)

details_adoptant_frm_g
```

Summary of global CIS-access farmers

```{r}

# Summary of number of CIS access households
summ_accfrm <- Q1_services %>% 
              filter(adopted_cases != "No accessed") %>%
              filter(!is.na(adopted_cases))  %>%
              group_by(region, country, site)  %>%  
              distinct(farmer_id, .keep_all = TRUE) %>% 
              count() %>% 
              mutate(category = "Farmers accessing CIS")  %>% 
              ungroup()

# Detail of % of CIS access households
details_access_frm <- summ_frm %>% 
                     ungroup() %>%
                     select(site, n) %>% 
                     inner_join(summ_accfrm %>% 
                                ungroup() %>%
                                select(site,n), by = "site") %>%
                     mutate(access_frm_perc = paste0(round(n.y*100/n.x, 0), 
                                                    "% accessed CIS"))%>%
                     select(-n.x, -n.y) 

details_access_frm
```


```{r sinthesis}

summaries <- rbind(summ_yea, summ_com, summ_prac, summ_hh, summ_weaxp_per, summ_frm)

#Read and join
coordinates <- read_csv(here::here("Data","EU-IFAD","CCAFS_Villages _coordinates_GPS.csv"))

# Get communities by site
details_communities <- aggregate(community ~ site, unique(coordinates), paste, collapse = "\n ") 


# Summaries with coordinates
coordinates_summ <- coordinates %>%
  #Copute coordinates for site
  group_by(site) %>%
  mutate(latitude_site = mean(latitude),
         longitude_site = mean(longitude)) %>%
  ungroup() %>%
  distinct(site, .keep_all = TRUE) %>%
  #Remove columns from communities
  select(-community, -longitude, -latitude)%>%
  #Join with details from communities by site and summaries
  right_join(details_communities, by = "site") %>%
  right_join(details_years, by = "site") %>%
  right_join(details_practices, by = "site") %>%
  right_join(details_access_hh, by = "site") %>%
  right_join(details_adoptant_hh_g, by = "site") %>%
  right_join(details_access_frm, by = "site") %>%
  right_join(details_adoptant_frm_g, by = "site") %>%
  right_join(details_weashk, by = "site") %>%
  right_join(summaries, by = c("region", "country", "site")) %>%
  # Edit deails column
  mutate(details = case_when(
    category == "Years" ~ as.character(year),
    category == "Practices" ~ as.character(practice_type),
    category == "Households" ~ as.character(paste(paste0(access_hh_perc,","),
                                                  adoptant_hh_g_perc,
                                                  sep = "\n")),
    category == "Weather shocks" ~ as.character(weather_details),
    category == "Farmers" ~ as.character(paste(paste0(access_frm_perc,","),
                                               adoptant_frm_g_perc,
                                               sep = "\n")),
    TRUE ~ as.character(community)
  )) %>%
  select(-community, -year, -practice_type, -adoptant_hh_g_perc, -adoptant_frm_g_perc, - weather_details, - access_hh_perc, - access_frm_perc)

coordinates_summ

```


```{r export_data}

write_csv(coordinates_summ, here::here("Data","EU-IFAD","locations.csv"))

```


```{r plot, echo = TRUE, include = TRUE}

library(grid)
library(tidyverse)
library(ggplot2)
library(ggrepel)

world_data <- ggplot2::map_data('world')%>%
  rename(country = region) %>%
  select(-subregion) %>%
  filter(country %in% coordinates_summ$country)

# Shift country names to allow labels visibility
world_labels <- world_data %>%
  group_by(country) %>%
   summarise(long = 
               case_when(country == "Ethiopia" ~ mean(long),
                    country == "Senegal" ~ mean(long),
                    country == "Mali" ~ mean(long) - mean(long)/1.5,
                    country == "Niger" ~ mean(long) + mean(long)/1.5), 
             lat = 
              case_when(country == "Ethiopia" ~ mean(lat),
                        country == "Senegal" ~ mean(lat) - mean(lat)/10,
                        country == "Mali" ~ mean(lat) + mean(lat)/5,
                        country == "Niger" ~ mean(lat) + mean(lat)/10))


g <- ggplot(data = world_data,
       aes(x = long, 
           y = lat)) +
  geom_polygon(data = world_data,
               aes(group = group),
               color = "#faf9f5", 
               fill = "#ECEBE7", 
               size = 1) +
  geom_text(data = world_labels, 
            aes(label = country),
            color = "#B8B7B3",
            size = 2.5)+
  geom_point(data = coordinates_summ 
             %>% filter(category == "Years"),
             aes(x = longitude_site, 
                 y = latitude_site, 
                 color = site,
                 size = n),
             shape = 19,
             alpha = 0.8)+
  scale_size_continuous(range = c(4.5,8))+
  scale_color_hue(l = 70, c = 40)+
  geom_label_repel(data = coordinates_summ 
                   %>% filter(category == "Years"),
                   aes(label = 
                         if(category == "Years"){
                           paste0("Years surveyed:\n", details)
                           } 
                       else if(category == "Communities"){
                         paste(n, "communities were surveyed")
                         }
                       else if(category == "Practices"){
                         paste("Practices were assessed:\n",details)
                         }
                       else if(category == "Households participants"){
                         paste(n,"households participated.\n",details)
                       }
                       else if(category == "Farmers participants"){
                         paste(n,"farmers participated.\n",details)
                       }
                       else {paste0(n, "% of households experienced shocks, mainly:\n",details)},
                       x = longitude_site, 
                       y = latitude_site,
                       color = site),
                   size = 4,
                   box.padding = 1,
                   point.padding = 0,
                   nudge_y = 0,
                   #color = "#5D5C58",
                   max.overlaps = Inf,
                   direction = "both",
                   xlim = c(-Inf, Inf),
                   alpha = 0.5)+
  guides(size = "none",
        color = guide_legend(override.aes = list(size = 5)))+
  labs(color = "Sites")+
  theme_minimal()+
  theme(panel.grid = element_blank(),
        plot.background = element_rect(fill = "#faf9f5", 
                                       color = "#faf9f5"),
        axis.text = element_blank(),
        axis.title = element_blank())+
    coord_quickmap()

gt <- ggplotGrob(g)
grid.newpage()
# Draw a rectangle with desired fill and color
grid.draw(rectGrob(gp = gpar(fill = "#faf9f5", col ="#faf9f5" )))
grid.draw(gt)




```

